<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>
  File: README
  
    &mdash; Documentation by YARD 0.8.7.3
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><div id='filecontents'><h1 id="sparkleformation">SparkleFormation</h1>

<p>AWS CloudFormation template building tools for Ruby. Yay!</p>

<h2 id="whats-it-do">What’s it do?</h2>

<p>Provides a very loose DSL to describe an AWS CloudFormation
in Ruby.</p>

<h2 id="is-that-it">Is that it?</h2>

<p>Yes. Well, kinda. It also has some extra features, like defining
components, dynamics, merging, AWS builtin function helpers, and
conjouring magic (to get unicorns).</p>

<h2 id="whats-it-look-like">What’s it look like?</h2>

<p>Lets use one of the example CF templates that creates an EC2 instance. First
we can just convert it into a single file (ec2_example.rb):</p>

<p>```ruby
SparkleFormation.new(‘ec2_example’) do
  description “AWS CloudFormation Sample Template …”</p>

<p>parameters.keyname do
    description ‘Name of EC2 key pair’
    type ‘string’
  end</p>

<p>mappings.region_map do
    set!(‘us-east-1’, :ami =&gt; ‘ami-7f418316’)
    set!(‘us-east-1’, :ami =&gt; ‘ami-7f418316’)
    set!(‘us-west-1’, :ami =&gt; ‘ami-951945d0’)
    set!(‘us-west-2’, :ami =&gt; ‘ami-16fd7026’)
    set!(‘eu-west-1’, :ami =&gt; ‘ami-24506250’)
    set!(‘sa-east-1’, :ami =&gt; ‘ami-3e3be423’)
    set!(‘ap-southeast-1’, :ami =&gt; ‘ami-74dda626’)
    set!(‘ap-northeast-1’, :ami =&gt; ‘ami-dcfa4edd’)
  end</p>

<p>dynamic!(:ec2_instance, :foobar) do
    properties do
      key_name ref!(:key_name)
      image_id map!(:region_map, ‘AWS::Region’, :ami)
      user_data base64!(‘80’)
    end
  end</p>

<p>outputs do
    instance_id do
      description ‘InstanceId of the newly created EC2 instance’
      value ref!(:foobar_ec2_instance)
    end
    az do
      description ‘Availability Zone of the newly created EC2 instance’
      value attr!(:foobar_ec2_instance, :availability_zone)
    end
    public_ip do
      description ‘Public IP address of the newly created EC2 instance’
      value attr!(:foobar_ec2_instance, :public_ip)
    end
    private_ip do
      description ‘Private IP address of the newly created EC2 instance’
      value attr!(:foobar_ec2_instance, :private_ip)
    end
    public_dns do
      description ‘Public DNSName of the newly created EC2 instance’
      value attr!(:foobar_ec2_instance, :public_dns_name)
    end
    private_dns do
      description ‘Private DNSName of the newly created EC2 instance’
      value attr!(:foobar_ec2_instance, :private_dns_name)
    end
  end
end
```</p>

<p>And once compiled we get a nice Hash that we can then convert to JSON which
is ready for AWS. To print:</p>

<p>```ruby
require ‘sparkle_formation’
require ‘json’</p>

<p>puts JSON.pretty_generate(
  SparkleFormation.compile(‘ec2_example.rb’)
)
```</p>

<p>Easy!</p>

<h2 id="why-not-just-write-json">Why not just write JSON?</h2>

<p>Because, who in their right mind would want to write all of that in JSON? Also,
we can start applying some of the underlying features in <code>SparkleFormation</code> to
make this easier to maintain.</p>

<h1 id="components">Components</h1>

<p>Lets say we have a handful of CF templates we want to maintain, and all of those
templates use the same AMI. Instead of copying that information into all the
templates, lets create an AMI component instead, and then load it into the actual
templates.</p>

<p>First, create the component (components/ami.rb):</p>

<p>```ruby
SparkleFormation.build(:ami) do</p>

<p>mappings.region_map do
    set!(‘us-east-1’, :ami =&gt; ‘ami-7f418316’)
    set!(‘us-east-1’, :ami =&gt; ‘ami-7f418316’)
    set!(‘us-west-1’, :ami =&gt; ‘ami-951945d0’)
    set!(‘us-west-2’, :ami =&gt; ‘ami-16fd7026’)
    set!(‘eu-west-1’, :ami =&gt; ‘ami-24506250’)
    set!(‘sa-east-1’, :ami =&gt; ‘ami-3e3be423’)
    set!(‘ap-southeast-1’, :ami =&gt; ‘ami-74dda626’)
    set!(‘ap-northeast-1’, :ami =&gt; ‘ami-dcfa4edd’)
  end</p>

<p>end
```</p>

<p>Now, we can modify our initial example to use this component (ec2_example.rb):</p>

<p>```ruby
SparkleFormation.new(‘ec2_example’).load(:ami) do</p>

<p>description “AWS CloudFormation Sample Template …”</p>

<p>parameters.keyname do
    description ‘Name of EC2 key pair’
    type ‘string’
  end</p>

<p>dynamic!(:ec2_instance, :foobar) do
    properties do
      key_name ref!(:key_name)
      image_id map!(:region_map, ‘AWS::Region’, :ami)
      user_data base64!(‘80’)
    end
  end</p>

<p>outputs do
    instance_id do
      description ‘InstanceId of the newly created EC2 instance’
      value ref!(:foobar_ec2_instance)
    end
    az do
      description ‘Availability Zone of the newly created EC2 instance’
      value attr!(:foobar_ec2_instance, :availability_zone)
    end
    public_ip do
      description ‘Public IP address of the newly created EC2 instance’
      value attr!(:foobar_ec2_instance, :public_ip)
    end
    private_ip do
      description ‘Private IP address of the newly created EC2 instance’
      value attr!(:foobar_ec2_instance, :private_ip)
    end
    public_dns do
      description ‘Public DNSName of the newly created EC2 instance’
      value attr!(:foobar_ec2_instance, :public_dns_name)
    end
    private_dns do
      description ‘Private DNSName of the newly created EC2 instance’
      value attr!(:foobar_ec2_instance, :private_dns_name)
    end
  end
end
```</p>

<p>Now a few things have changed. Instead of passing a block directly to the
instance instantiation, we are loading a component (the <code>ami</code> component)
into the formation, and then applying an override block on top of the <code>ami</code>
component. The result is the same as the initial example, but now we have
a DRY component to use. Great!</p>

<h2 id="dynamics">Dynamics</h2>

<p>Okay, so lets say we want to have two ec2 instances. We could duplicate the
resource and outputs, renaming where required. This would get ugly quick,
especially as more instances are added. Making a component for the ec2 resource
won’t really help since components are static, used to apply the same common
parts to multiple templates. So what do we use?</p>

<p>Enter <code>dynamics</code>. These are much like components, except that instead of simply
being merged, they allow passing of arguments which makes them reusable to create
unique resources. So, from our last example, lets move the ec2 related items
into a dynamic (dynamics/node.rb):</p>

<p>```ruby
SparkleFormation.dynamic(:node,
  :parameters =&gt; {
    :key_name =&gt; {
      :type =&gt; ‘String’,
      :description =&gt; ‘Optionally make keypair static’
    }
  }
) do |_name, _config|</p>

<p>if(_config[:key_name])
    parameters.keyname do
      description ‘Name of EC2 key pair’
      type ‘string’
    end
  end</p>

<p>dynamic!(:ec2_instance, _name) do
    properties do
      key_name _config.fetch(:key_name, ref!(:key_name))
      image_id map!(:region_map, ‘AWS::Region’, :ami)
      user_data baes64!(‘80’)
    end
  end</p>

<p>outputs(“#_name_instance_id”.to_sym) do
    description ‘InstanceId of the newly created EC2 instance’
    value ref!(“#_name_ec2_instance”.to_sym)
  end
  outputs(“#_name_az”.to_sym) do
    description ‘Availability Zone of the newly created EC2 instance’
    value attr!(“#_name_ec2_instance”.to_sym, :availability_zone)
  end
  outputs(“#_name_public_ip”.to_sym) do
    description ‘Public IP address of the newly created EC2 instance’
    value attr!(“#_name_ec2_instance”.to_sym, :public_ip)
  end
  outputs(“#_name_private_ip”.to_sym) do
    description ‘Private IP address of the newly created EC2 instance’
    value attr!(“#_name_ec2_instance”.to_sym, :private_ip)
  end
  outputs(“#_name_public_dns”.to_sym) do
    description ‘Public DNSName of the newly created EC2 instance’
    value attr!(“#_name_ec2_instance”.to_sym, :public_dns_name)
  end
  outputs(“#_name_private_dns”.to_sym) do
    description ‘Private DNSName of the newly created EC2 instance’
    value attr!(“#_name_ec2_instance”.to_sym, :private_dns_name)
  end
end
```</p>

<p>Now we can put all of these together, and create multiple ec2 instance
resource easily:</p>

<p>```ruby
SparkleFormation.new(‘ec2_example’).load(:ami).overrides do</p>

<p>description “AWS CloudFormation Sample Template …”</p>

<p>%w(node1 node2 node3).each do |_node_name|
    dynamic!(:node, _node_name)
  end</p>

<p># and include one with predefined keypair</p>

<p>dynamic!(:node, ‘snowflake’, :key_pair =&gt; ‘snowkeys’)
end
```</p>

<h2 id="todo">TODO</h2>
<ul>
  <li>Add information about symbol importance</li>
  <li>Add examples of camel case control</li>
  <li>Add examples of complex merge strategies</li>
  <li>Add examples of accessing parent hash elements</li>
</ul>

<h1 id="infos">Infos</h1>
<ul>
  <li>Repository: https://github.com/heavywater/sparkle_formation</li>
  <li>IRC: Freenode @ #heavywater</li>
</ul>
</div></div>

    <div id="footer">
  Generated on Tue Oct 28 11:50:54 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.3 (ruby-2.1.2).
</div>

  </body>
</html>