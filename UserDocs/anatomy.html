<h2>Template Anatomy</h2>

<h3>Parameters</h3>

<p>Parameters are prompts for stack specific values. A default may be
specified, but is not required. Every parameter must have a value at runtime.</p>

<p>In the Getting Started example we had one parameter, <code>web_nodes</code> which
set the min and max for the autoscaling group:</p>

<p><code>ruby
parameters.web_nodes do
  type &#39;Number&#39;
  description &#39;Number of web nodes for ASG.&#39;
  default 2
end
</code></p>

<p>Every parameter must have a type and a description. Available types are <code>String</code>,
<code>Number</code> (an integer), and <code>CommaDelimitedList</code> (an array of
strings, as-in: <code>[&#39;alpha&#39;, &#39;beta&#39;, &#39;1&#39;, 2&#39;]</code>). The descriptions is a
string describing the resource. </p>

<p>Parameters support optional default values, declared as
above. An array of accepted values may be set, as well:</p>

<p><code>ruby
parameters.web_nodes do
  type &#39;Number&#39;
  description &#39;Number of web nodes for ASG.&#39;
  default 2
  allowed_values [1, 2, 3, 5]
end
</code></p>

<h3>Resources</h3>

<p>Resources are the infrastructure resources that are provisioned with
the stack. Every resource must have a type that corresponds to a
supported cloud resource. Resources typically have a properties hash
that configures the resource. Some resources also have metadata. For
the complete list of required and optional options, see the
individual resource documentation.</p>

<p>Resource availability is not consistent across
providers. SparkleFormation&#39;s resources support is based on AWS, and
not all resources will be available on other platforms. See the
<a href="resource-reference.md">resource reference</a> table for more information.</p>

<p>The prior example included the following resources:
- cfn_user: The IAM user for the stack, which will be used to
provision stack resources.</p>

<p><code>ruby
resources.cfn_user do
  type &#39;AWS::IAM::User&#39;
  properties.path &#39;/&#39;
  properties.policies _array(
    -&gt; {
      policy_name &#39;cfn_access&#39;
      policy_document.statement _array(
        -&gt; {
          effect &#39;Allow&#39;
          action &#39;cloudformation:DescribeStackResource&#39;
          resource &#39;*&#39; 
        }
      )
    }
  )
end
</code></p>

<ul>
<li>cfn_key: The IAM keys for the stack IAM user.</li>
</ul>

<p><code>ruby
resources.cfn_keys do
  type &#39;AWS::IAM::AccessKey&#39;
  properties.user_name ref!(:cfn_user)
end
</code></p>

<ul>
<li>website<em>asg: The autoscaling group containing website nodes. The
size of the autoscaling group is set to the value of the web</em>nodes
parameter. </li>
</ul>

<p><code>ruby
resources.website_autoscale do
  type &#39;AWS::AutoScaling::AutoScalingGroup&#39;
  properties do
    availability_zones({&#39;Fn::GetAZs&#39; =&gt; &#39;&#39;})
    launch_configuration_name ref!(:website_launch_config)
    min_size ref!(:web_nodes)
    max_size ref!(:web_nodes)
  end
end
</code></p>

<ul>
<li>website<em>launch</em>configuration: The launch configuration for
website_asg nodes. The AMI image ID and instance type (size) are
required. </li>
</ul>

<p><code>ruby
resources.website_launch_config do
  type &#39;AWS::AutoScaling::LaunchConfiguration&#39;
  properties do
    image_id &#39;ami-123456&#39;
    instance_type &#39;m3.medium&#39;
  end
end
</code></p>

<ul>
<li>website_elb: The elastic load balancer for the website. The
listeners array configures port forwarding. The health check
configures the load balancer health check target and thresholds.</li>
</ul>

<p><code>ruby
resources.website_elb do
  type &#39;AWS::ElasticLoadBalancing::LoadBalancer&#39;
  properties do
    availability_zones._set(&#39;Fn::GetAZs&#39;, &#39;&#39;)
    listeners _array(
      -&gt; {
        load_balancer_port &#39;80&#39;
        protocol &#39;HTTP&#39;
        instance_port &#39;80&#39;
        instance_protocol &#39;HTTP&#39;
      }
    )
    health_check do
      target &#39;HTTP:80/&#39;
      healthy_threshold &#39;3&#39;
      unhealthy_threshold &#39;3&#39;
      interval &#39;5&#39;
      timeout &#39;15&#39;
    end
  end
end
</code></p>

<h3>Mappings</h3>

<p>Mappings allow you to create key/value pairs which can be referenced
at runtime. This is useful for things like an image id that differs
by region or environment. </p>

<p>Mappings for the 2014.09 Amazon Linux PV Instance Store 64-bit AMIs
for each US region:</p>

<p><code>ruby
mappings.region_map do
  set!(&#39;us-east-1&#39;, :ami =&gt; &#39;ami-8e852ce6&#39;)
  set!(&#39;us-west-1&#39;, :ami =&gt; &#39;ami-03a8a146&#39;)
  set!(&#39;us-west-2&#39;, :ami =&gt; &#39;ami-f786c6c7&#39;)
end
</code></p>

<p>These can be referenced, in turn, with the following:</p>

<p><code>ruby
map!(:region_map, ref!(&#39;AWS::Region&#39;), :ami)
</code></p>

<p>&#39;AWS::Region&#39; is a psuedo parameter. We could also perform a lookup
based on a parameter we provide, e.g. an instance size based on the environment:</p>

<p>```ruby
parameters.environment do
  type &#39;String&#39;
  allowed_values [&#39;development&#39;, &#39;staging&#39;, &#39;production&#39;]<br>
end</p>

<p>mappings.instance_size do
  set!(&#39;development&#39;, :instance =&gt; &#39;m3.small&#39;)
  set!(&#39;staging&#39;, :instance =&gt; &#39;m3.medium&#39;)
  set!(&#39;production&#39;, :instance =&gt; &#39;m3.large&#39;)
end</p>

<p>resources.website<em>launch</em>config do
  type &#39;AWS::AutoScaling::LaunchConfiguration&#39;
  properties do
    image<em>id map!(:region</em>map, &#39;AWS::Region&#39;, :ami)
    instance<em>type map!(:instance</em>size, ref!(:environment), :instance)
  end
end
```</p>

<h3>Outputs</h3>

<p>Outputs provide metadata for the stack, as key/value pairs within an
outputs block. Note that this block lives outside the resource
blocks. This will retrieve the DNSName attribute for our load
balancer, and provide it as a value for an &#39;Elb Dns&#39; output:</p>

<p><code>ruby
outputs do
  elb_dns do
    value attr!(:website_elb, &#39;DNSName&#39;)
    description &quot;Website ELB DNS name&quot;
  end
end
</code></p>

<p>Outputs are not simply informational. You can interact with them
during <a href="provisioning.md#knife-cloudformation">provisioning</a> using the <a href="https://rubygems.org/gems/knife-cloudformation">knife-cloudformation
plugin</a>. </p>
